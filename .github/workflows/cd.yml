# Jun Kai
name: CD Pipeline

on:
  push:
    branches: [ main ] # Only triggers when code is successfully merged into main

permissions:
  contents: read
  security-events: write   # needed so SARIF upload works (Trivy results in Security tab)

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Initialize Docker Swarm
        run: docker swarm init || true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Lint Python Code
        run: |
          pip install flake8
          pip install -r tic-tac-toe/requirements.txt
          flake8 tic-tac-toe/app.py --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 tic-tac-toe/app.py --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./tic-tac-toe
          file: ./tic-tac-toe/Dockerfile
          push: false
          tags: tttapp:${{ github.sha }}
          load: true

      - name: Scan Docker Image for Vulnerabilities
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'tttapp:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Deploy Swarm Stack
        run: |
          export IMAGE_TAG=${{ github.sha }}
          docker stack deploy -c tic-tac-toe/stack.yml tttstack

      - name: Validate Stack Configuration
        run: docker compose -f tic-tac-toe/stack.yml config

      - name: Check Stack Status
        run: docker stack ps tttstack

      - name: Wait for Services to be Ready
        run: |
          echo "Waiting for services to be running..."
          timeout 300 bash -c 'while ! docker stack ps tttstack | grep -q "Running"; do sleep 10; echo "Checking..."; done'
          echo "Services are running."

      - name: Clean up
        if: always()
        run: |
          docker image prune -f
          docker system prune -f

      - name: Notify on Success
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "Image tag: tttapp:${{ github.sha }}"
          echo "Stack: tttstack"
          echo "Access the app at http://localhost:3307"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Check the logs above for details."
          echo "You may need to manually rollback or fix issues."
