name: CD Pipeline

on:
  push:
    branches: [ main ] # Only triggers when code is successfully merged into main

permissions:
  contents: read
  security-events: write   # needed so SARIF upload works (Trivy results in Security tab)

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Initialize Docker Swarm
        run: docker swarm init || true

      - name: Cache Docker layers
        uses: actions/cache@v5
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ hashFiles('tic-tac-toe/Dockerfile') }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Lint Python Code
        run: |
          pip install flake8
          flake8 tic-tac-toe/app.py --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 tic-tac-toe/app.py --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: Build Docker Image
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # Used latest version v6.18.0
        with:
          context: ./tic-tac-toe
          file: ./tic-tac-toe/Dockerfile
          push: false
          tags: tttapp:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      - name: Scan Docker Image for Vulnerabilities
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8   # SHA instead of @master
        with:
          scan-type: 'image'
          image-ref: 'tttapp:${{ github.sha }}'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v4   # newer upload action
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Deploy Swarm Stack
        run: |
          export IMAGE_TAG=${{ github.sha }}
          docker stack deploy -c tic-tac-toe/stack.yml tttstack

      - name: Validate Stack Configuration
        run: docker compose -f tic-tac-toe/stack.yml config   

      - name: Check Stack Status
        run: docker stack ps tttstack

      - name: Wait for Services to be Ready
        run: |
          echo "Waiting for services to be running..."
          timeout 300 bash -c 'while ! docker stack ps tttstack | grep -q "Running"; do sleep 10; echo "Checking..."; done'
          echo "Services are running."

      - name: Clean up
        if: always()
        run: |
          docker image prune -f
          docker system prune -f

      - name: Notify on Success
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "Image tag: tttapp:${{ github.sha }}"
          echo "Stack: tttstack"
          echo "Access the app at http://localhost:3307"

      - name: Notify on Failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "Check the logs above for details."
          echo "You may need to manually rollback or fix issues."
